# we eat variables for breakfast
$app_stage     = "<%= app_stage %>"
$app_domain    = "<%= app_domain %>"
$app_deploy_to = "<%= app_deploy_to %>"
$app_name      = "<%= app_name %>"
$app_user      = "<%= app_user %>"
$app_group     = "<%= app_group %>"

<%
if app_stage == "dev"
  erb_path = "#{app_deploy_to}/current/config/puppet/templates"
else
  erb_path = "/home/deploy/tmp/#{app_name}/#{app_stage}/templates"
end
%>

package { "nginx":
	ensure => latest,
#	hasrestart => true
}

package { "varnish":
	ensure => latest
}

<% if app_stage == "dev" %>
# to hack around the name resolution problem with a 12.04 host, Peter's env only
file { "/etc/resolv.conf":
	owner => root,
	group => root,
	mode => 644,
	source => "<%= app_deploy_to %>/current/config/puppet/files/vagrant_resolv.conf"
}

<% end %>

file { "/etc/nginx/sites-available/<%= app_name %>-<%= app_stage %>":
	owner => root,
	group => root,
	mode  => 644,
	content => template("<%= erb_path %>/nginx.erb"),
	require => Package["nginx"],
	notify => Service["nginx"]
}

file { "/etc/nginx/sites-enabled/<%= app_name %>-<%= app_stage %>":
	ensure => symlink,
	target => "/etc/nginx/sites-available/<%= app_name %>-<%= app_stage %>",
	require => Package["nginx"],
	notify => Service["nginx"]
}

file { "/etc/nginx/sites-enabled/default":
	ensure => absent,
	#require => Package["nginx"],
	#notify => Package["nginx"]
}

group { "<%= app_user %>-homerw":
	ensure => present,
}

group { "<%= app_group %>":
	ensure => present,
}

user { "www-data":
	ensure => present,
	groups => ["<%= app_user %>-homerw"],
	membership => minimum,
}

user { "peter":
	ensure => present,
	groups => ["<%= app_user %>-homerw","<%= app_group %>"],
	membership => minimum,
}

user { "chris":
	ensure => present,
	groups => ["<%= app_user %>-homerw","<%= app_group %>"],
	membership => minimum,
}

user { "deploy":
	ensure => present,
	groups => ["<%= app_user %>-homerw","<%= app_group %>"],
	membership => minimum,
}

<% if app_stage != "dev" %>
user { "<%= app_user %>":
	ensure => present,
	gid => "<%= app_group %>",
	groups => ["<%= app_user %>-homerw"],
	membership => minimum,
	password => "*", # disable password-based logins entirely
}
<% else %>
user { "vagrant":
	ensure => present,
	gid => "<%= app_user %>",
	groups => ["<%= app_user %>-homerw","<%= app_group %>"],
	membership => minimum,
}
<% end %>

<% if app_stage != "dev" %>
file { "/home/<%= app_user %>":
	ensure => directory,
	owner => <%= app_user %>,
	group => <%= app_user %>-homerw,
	mode => 770,
}
<% else %>
file { "/home/<%= app_user %>":
	ensure => directory,
	owner => vagrant,
	group => vagrant-homerw,
	mode => 755,
}
<% end %>


<% if app_stage == "dev" %>
# varnish config file for :80
file { "/etc/default/varnish":
	owner => root,
	group => root,
	source => "<%= app_deploy_to %>/current/config/puppet/files/vagrant_etc_default_varnish",
	require => Package["varnish"]
}

file { "/etc/varnish/default.vcl":
	owner => root,
	group => root,
	source => "<%= app_deploy_to %>/current/config/puppet/files/vagrant_default.vcl",
	require => Package["varnish"]
}
<% end %>

service { "nginx":
	ensure => running,
	#hasrestart => true,
	require => Package["nginx"]
}

# start varnish
service { "varnish":
	ensure => running,
	require => Package["varnish"],
	<% if app_stage == "dev" %>
	subscribe => [File["/etc/default/varnish"],File["/etc/varnish/default.vcl"]],
	<% end %>
}